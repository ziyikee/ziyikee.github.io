(window.HUYA_MAIN_APP_WEBPACK_JSONP=window.HUYA_MAIN_APP_WEBPACK_JSONP||[]).push([[97],{335:function(t,e,r){t.exports=function(){"use strict";var t=function(t){if(Array.isArray(t))return t},e=function(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var r=[],n=!0,o=!1,i=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!e||r.length!==e);n=!0);}catch(t){o=!0,i=t}finally{try{n||null==s.return||s.return()}finally{if(o)throw i}}return r}},r=function(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n},n=function(t,e){if(t){if("string"==typeof t)return r(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(t,e):void 0}},o=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},i=function(r,i){return t(r)||e(r,i)||n(r,i)||o()};function a(t,e){return t(e={exports:{}},e.exports),e.exports}var s=a((function(t){var e=function(t){var e=Object.prototype,r=e.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},o=n.iterator||"@@iterator",i=n.asyncIterator||"@@asyncIterator",a=n.toStringTag||"@@toStringTag";function s(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{s({},"")}catch(t){s=function(t,e,r){return t[e]=r}}function c(t,e,r,n){var o=e&&e.prototype instanceof h?e:h,i=Object.create(o.prototype),a=new T(n||[]);return i._invoke=function(t,e,r){var n="suspendedStart";return function(o,i){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===o)throw i;return{value:void 0,done:!0}}for(r.method=o,r.arg=i;;){var a=r.delegate;if(a){var s=b(a,r);if(s){if(s===l)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(t,e,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===l)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}(t,r,a),i}function u(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}t.wrap=c;var l={};function h(){}function f(){}function p(){}var v={};v[o]=function(){return this};var d=Object.getPrototypeOf,m=d&&d(d(E([])));m&&m!==e&&r.call(m,o)&&(v=m);var y=p.prototype=h.prototype=Object.create(v);function g(t){["next","throw","return"].forEach((function(e){s(t,e,(function(t){return this._invoke(e,t)}))}))}function x(t,e){var n;this._invoke=function(o,i){function a(){return new e((function(n,a){!function n(o,i,a,s){var c=u(t[o],t,i);if("throw"!==c.type){var l=c.arg,h=l.value;return h&&"object"==typeof h&&r.call(h,"__await")?e.resolve(h.__await).then((function(t){n("next",t,a,s)}),(function(t){n("throw",t,a,s)})):e.resolve(h).then((function(t){l.value=t,a(l)}),(function(t){return n("throw",t,a,s)}))}s(c.arg)}(o,i,n,a)}))}return n=n?n.then(a,a):a()}}function b(t,e){var r=t.iterator[e.method];if(void 0===r){if(e.delegate=null,"throw"===e.method){if(t.iterator.return&&(e.method="return",e.arg=void 0,b(t,e),"throw"===e.method))return l;e.method="throw",e.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=u(r,t.iterator,e.arg);if("throw"===n.type)return e.method="throw",e.arg=n.arg,e.delegate=null,l;var o=n.arg;return o?o.done?(e[t.resultName]=o.value,e.next=t.nextLoc,"return"!==e.method&&(e.method="next",e.arg=void 0),e.delegate=null,l):o:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,l)}function _(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function w(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function T(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(_,this),this.reset(!0)}function E(t){if(t){var e=t[o];if(e)return e.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,i=function e(){for(;++n<t.length;)if(r.call(t,n))return e.value=t[n],e.done=!1,e;return e.value=void 0,e.done=!0,e};return i.next=i}}return{next:A}}function A(){return{value:void 0,done:!0}}return f.prototype=y.constructor=p,p.constructor=f,f.displayName=s(p,a,"GeneratorFunction"),t.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===f||"GeneratorFunction"===(e.displayName||e.name))},t.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,p):(t.__proto__=p,s(t,a,"GeneratorFunction")),t.prototype=Object.create(y),t},t.awrap=function(t){return{__await:t}},g(x.prototype),x.prototype[i]=function(){return this},t.AsyncIterator=x,t.async=function(e,r,n,o,i){void 0===i&&(i=Promise);var a=new x(c(e,r,n,o),i);return t.isGeneratorFunction(r)?a:a.next().then((function(t){return t.done?t.value:a.next()}))},g(y),s(y,a,"Generator"),y[o]=function(){return this},y.toString=function(){return"[object Generator]"},t.keys=function(t){var e=[];for(var r in t)e.push(r);return e.reverse(),function r(){for(;e.length;){var n=e.pop();if(n in t)return r.value=n,r.done=!1,r}return r.done=!0,r}},t.values=E,T.prototype={constructor:T,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(w),!t)for(var e in this)"t"===e.charAt(0)&&r.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=void 0)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var e=this;function n(r,n){return a.type="throw",a.arg=t,e.next=r,n&&(e.method="next",e.arg=void 0),!!n}for(var o=this.tryEntries.length-1;o>=0;--o){var i=this.tryEntries[o],a=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var s=r.call(i,"catchLoc"),c=r.call(i,"finallyLoc");if(s&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(s){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=t,a.arg=e,i?(this.method="next",this.next=i.finallyLoc,l):this.complete(a)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),l},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),w(r),l}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;w(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(t,e,r){return this.delegate={iterator:E(t),resultName:e,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},t}(t.exports);try{regeneratorRuntime=e}catch(t){Function("r","regeneratorRuntime = r")(e)}})),c=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")};function u(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var l=function(t,e,r){return e&&u(t.prototype,e),r&&u(t,r),t},h=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t},f=a((function(t){function e(r){return t.exports=e=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},e(r)}t.exports=e})),p=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=f(t)););return t},v=a((function(t){function e(r,n,o){return"undefined"!=typeof Reflect&&Reflect.get?t.exports=e=Reflect.get:t.exports=e=function(t,e,r){var n=p(t,e);if(n){var o=Object.getOwnPropertyDescriptor(n,e);return o.get?o.get.call(r):o.value}},e(r,n,o||r)}t.exports=e})),d=a((function(t){function e(r,n){return t.exports=e=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t},e(r,n)}t.exports=e})),m=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&d(t,e)},y=a((function(t){function e(r){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=e=function(t){return typeof t}:t.exports=e=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(r)}t.exports=e})),g=function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t},x=function(t,e){return!e||"object"!==y(e)&&"function"!=typeof e?g(t):e},b=a((function(t){function e(r){return t.exports=e=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)},e(r)}t.exports=e}));
/*! *****************************************************************************
  Copyright (c) Microsoft Corporation.

  Permission to use, copy, modify, and/or distribute this software for any
  purpose with or without fee is hereby granted.

  THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
  REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
  AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
  INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
  LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
  OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
  PERFORMANCE OF THIS SOFTWARE.
  ***************************************************************************** */
function _(t,e,r,n){return new(r||(r=Promise))((function(o,i){function a(t){try{c(n.next(t))}catch(t){i(t)}}function s(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(a,s)}c((n=n.apply(t,e||[])).next())}))}var w=a((function(t){function e(r){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=e=function(t){return typeof t}:t.exports=e=function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},e(r)}t.exports=e})),T=function(){function t(e,r){c(this,t),this.config=e||{},this.headData=r,this.frame=[],this.textureMap={}}return l(t,[{key:"init",value:function(){return _(this,void 0,void 0,s.mark((function t(){return s.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.initCanvas(),!/\/\/[-A-Za-z0-9+&@#/%?=~_|!:,.;]+[-A-Za-z0-9+&@#/%=~_|]\.json$/.test(this.config)){t.next=5;break}return t.next=4,this.getConfigBySrc(this.config);case 4:this.config=t.sent;case 5:return t.next=7,this.parseSrc(this.config);case 7:return this.canvas.parentNode.removeChild(this.canvas),this.frame=this.config.frame||[],t.abrupt("return",this);case 10:case"end":return t.stop()}}),t,this)})))}},{key:"initCanvas",value:function(){var t=document.createElement("canvas"),e=t.getContext("2d");t.style.display="none",document.body.appendChild(t),this.ctx=e,this.canvas=t}},{key:"loadImg",value:function(t){return new Promise((function(e,r){var n=new Image;n.crossOrigin="anonymous",n.onload=function(){e(this)},n.onerror=function(e){console.error("frame 资源加载失败:"+t),r(new Error("frame 资源加载失败:"+t))},n.src=t}))}},{key:"parseSrc",value:function(t){var e=this,r=this.srcData={};return Promise.all((t.src||[]).map((function(t){return _(e,void 0,void 0,s.mark((function e(){var n=this;return s.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.img=null,this.headData[t.srcTag.slice(1,t.srcTag.length-1)]){e.next=5;break}console.warn("vap: 融合信息没有传入：".concat(t.srcTag)),e.next=22;break;case 5:if("txt"!==t.srcType){e.next=11;break}this.headData.fontStyle&&!t.fontStyle&&(t.fontStyle=this.headData.fontStyle),t.textStr=t.srcTag.replace(/\[(.*)\]/,(function(t,e){return n.headData[e]})),t.img=this.makeTextImg(t),e.next=21;break;case 11:if("img"!==t.srcType){e.next=21;break}return t.imgUrl=t.srcTag.replace(/\[(.*)\]/,(function(t,e){return n.headData[e]})),e.prev=13,e.next=16,this.loadImg(t.imgUrl);case 16:t.img=e.sent,e.next=21;break;case 19:e.prev=19,e.t0=e.catch(13);case 21:t.img&&(r[t.srcId]=t);case 22:case"end":return e.stop()}}),e,this,[[13,19]])})))})))}},{key:"getConfigBySrc",value:function(t){return new Promise((function(e,r){var n=new XMLHttpRequest;n.open("GET",t,!0),n.responseType="json",n.onload=function(){if(200===n.status||304===n.status&&n.response){var t=n.response;e(t)}else r(new Error("http response invalid"+n.status))},n.send()}))}},{key:"makeTextImg",value:function(t){var e=t.textStr,r=t.w,n=t.h,o=t.color,i=t.style,a=t.fontStyle,s=this.ctx;s.canvas.width=r,s.canvas.height=n,s.textBaseline="middle",s.textAlign="center";var c=function(){var t=Math.min(r/e.length,n-8),o=["".concat(t,"px"),"Arial"];return"b"===i&&o.unshift("bold"),o.join(" ")};return a?"string"==typeof a?(s.font=a,s.fillStyle=o):"object"==w(a)?(s.font=a.font||c(),s.fillStyle=a.color||o):"function"==typeof a&&(s.font=c(),s.fillStyle=o,a.call(null,s,t)):(s.font=c(),s.fillStyle=o),s.clearRect(0,0,s.canvas.width,s.canvas.height),s.fillText(e,r/2,n/2),s.getImageData(0,0,r,n)}},{key:"getFrame",value:function(t){return this.frame.find((function(e){return e.i===t}))}}]),t}();function E(t,e,r){var n=t.createShader(e);return t.shaderSource(n,r),t.compileShader(n),n}function A(t,e,r){var n=t.createTexture(),o=t.TEXTURE0+e;return t.activeTexture(o),t.bindTexture(t.TEXTURE_2D,n),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),r&&t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r),n}function S(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,n=b(t);if(e){var o=b(this).constructor;r=Reflect.construct(n,arguments,o)}else r=n.apply(this,arguments);return x(this,r)}}var C=null,P={};function F(t,e,r,n,o,i){return[t/o,(t+r)/o,(i-e-n)/i,(i-e)/i]}var k,R=function(t){m(r,t);var e=S(r);function r(t){var n;return c(this,r),(n=e.call(this,t)).useFrameCallback&&(n.animId=n.video.requestVideoFrameCallback(n.drawFrame.bind(h(n)))),n.insType=n.options.type,P[n.insType]?n.instance=P[n.insType]:n.instance=P[n.insType]={},n.textures=[],n.buffers=[],n.shaders=[],n.init(),n}return l(r,[{key:"init",value:function(){return _(this,void 0,void 0,s.mark((function t(){return s.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.setCanvas(),!this.options.config){t.next=12;break}return t.prev=2,t.next=5,new T(this.options.config,this.options).init();case 5:this.vapFrameParser=t.sent,this.resources=this.vapFrameParser.srcData,t.next=12;break;case 9:t.prev=9,t.t0=t.catch(2),console.error("[Alpha video] parse vap frame error.",t.t0);case 12:this.resources=this.resources||{},this.initWebGL(),this.play();case 15:case"end":return t.stop()}}),t,this,[[2,9]])})))}},{key:"setCanvas",value:function(){var t=this.instance.canvas,e=this.options,r=e.width,n=e.height;t||(t=this.instance.canvas=document.createElement("canvas")),t.width=r,t.height=n,this.container.appendChild(t)}},{key:"initWebGL",value:function(){var t=this.instance.canvas,e=this.instance,r=e.gl,n=e.vertexShader,o=e.fragmentShader,i=e.program;if(t)return r||(this.instance.gl=r=t.getContext("webgl")||t.getContext("experimental-webgl"),r.disable(r.BLEND),r.blendFuncSeparate(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA,r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0)),r.clear(r.COLOR_BUFFER_BIT),r?(r.viewport(0,0,t.width,t.height),n||(n=this.instance.vertexShader=this.initVertexShader()),o||(o=this.instance.fragmentShader=this.initFragmentShader()),i||(i=this.instance.program=function(t,e,r){var n=t.createProgram();return t.attachShader(n,e),t.attachShader(n,r),t.linkProgram(n),t.useProgram(n),n}(r,n,o)),this.program=i,this.initTexture(),this.initVideoTexture(),r):void 0}},{key:"initVertexShader",value:function(){var t=this.instance.gl;return E(t,t.VERTEX_SHADER,"attribute vec2 a_position; // 接受顶点坐标\n             attribute vec2 a_texCoord; // 接受纹理坐标\n             attribute vec2 a_alpha_texCoord; // 接受纹理坐标\n             varying vec2 v_alpha_texCoord; // 接受纹理坐标\n             varying   vec2 v_texcoord; // 传递纹理坐标给片元着色器\n             void main(void){\n                gl_Position = vec4(a_position, 0.0, 1.0); // 设置坐标\n                v_texcoord = a_texCoord; // 设置纹理坐标\n                v_alpha_texCoord = a_alpha_texCoord; // 设置纹理坐标\n             }")}},{key:"initFragmentShader",value:function(){var t=this.instance.gl,e=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)-1,r="",n="";if(e>0){for(var o=[],i=[],a=0;a<e;a++)o.push("if(ndx == ".concat(a+1,"){\n                        color = texture2D(u_image").concat(a+1,",uv);\n                    }")),i.push("uniform sampler2D u_image".concat(a+1,";"));n="\n            ".concat(i.join("\n"),"\n            uniform float image_pos[").concat(9*e,"];\n            vec4 getSampleFromArray(int ndx, vec2 uv) {\n                vec4 color;\n                ").concat(o.join(" else "),"\n                return color;\n            }\n            "),r="\n            vec4 srcColor,maskColor;\n            vec2 srcTexcoord,maskTexcoord;\n            int srcIndex;\n            float x1,x2,y1,y2,mx1,mx2,my1,my2; //显示的区域\n\n            for(int i=0;i<".concat(9*e,";i+= ").concat(9,"){\n                if ((int(image_pos[i]) > 0)) {\n                  srcIndex = int(image_pos[i]);\n    \n                    x1 = image_pos[i+1];\n                    x2 = image_pos[i+2];\n                    y1 = image_pos[i+3];\n                    y2 = image_pos[i+4];\n                    \n                    mx1 = image_pos[i+5];\n                    mx2 = image_pos[i+6];\n                    my1 = image_pos[i+7];\n                    my2 = image_pos[i+8];\n    \n    \n                    if (v_texcoord.s>x1 && v_texcoord.s<x2 && v_texcoord.t>y1 && v_texcoord.t<y2) {\n                        srcTexcoord = vec2((v_texcoord.s-x1)/(x2-x1),(v_texcoord.t-y1)/(y2-y1));\n                         maskTexcoord = vec2(mx1+srcTexcoord.s*(mx2-mx1),my1+srcTexcoord.t*(my2-my1));\n                         srcColor = getSampleFromArray(srcIndex,srcTexcoord);\n                         maskColor = texture2D(u_image_video, maskTexcoord);\n                         srcColor.a = srcColor.a*(maskColor.r);\n                      \n                         bgColor = vec4(srcColor.rgb*srcColor.a,srcColor.a) + (1.0-srcColor.a)*bgColor;\n                      \n                    }   \n                }\n            }\n            ")}var s="\n        precision lowp float;\n        varying vec2 v_texcoord;\n        varying vec2 v_alpha_texCoord;\n        uniform sampler2D u_image_video;\n        ".concat(n,"\n        \n        void main(void) {\n            vec4 bgColor = ").concat("vec4(texture2D(u_image_video, v_texcoord).rgb, texture2D(u_image_video,v_alpha_texCoord).r);","\n            ").concat(r,"\n            // bgColor = texture2D(u_image[0], v_texcoord);\n            gl_FragColor = bgColor;\n        }\n        ");return E(t,t.FRAGMENT_SHADER,s)}},{key:"initTexture",value:function(){var t=this.instance.gl,e=1;if(this.vapFrameParser&&this.vapFrameParser.srcData){var r=this.vapFrameParser.srcData;for(var n in r){var o=r[n];this.textures.push(A(t,e,o.img));var i=t.getUniformLocation(this.program,"u_image".concat(e));t.uniform1i(i,e),this.vapFrameParser.textureMap[o.srcId]=e++}var a=t.createTexture();t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,a),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,null),this.videoTexture=A(t,e);var s=t.getUniformLocation(this.program,"u_image_video");t.uniform1i(s,e)}}},{key:"initVideoTexture",value:function(){var t=this.instance.gl,e=t.createBuffer();if(this.buffers.push(e),this.vapFrameParser&&this.vapFrameParser.config&&this.vapFrameParser.config.info){var r=this.vapFrameParser.config.info,n=[],o=r.videoW,a=r.videoH,s=i(r.rgbFrame,4),c=s[0],u=s[1],l=s[2],h=s[3],f=i(r.aFrame,4),p=f[0],v=f[1],d=f[2],m=f[3],y=F(c,u,l,h,o,a),g=F(p,v,d,m,o,a);n.push.apply(n,[-1,1,y[0],y[3],g[0],g[3]]),n.push.apply(n,[1,1,y[1],y[3],g[1],g[3]]),n.push.apply(n,[-1,-1,y[0],y[2],g[0],g[2]]),n.push.apply(n,[1,-1,y[1],y[2],g[1],g[2]]);var x=new Float32Array(n);t.bindBuffer(t.ARRAY_BUFFER,e),t.bufferData(t.ARRAY_BUFFER,x,t.STATIC_DRAW),this.aPosition=t.getAttribLocation(this.program,"a_position"),t.enableVertexAttribArray(this.aPosition),this.aTexCoord=t.getAttribLocation(this.program,"a_texCoord"),t.enableVertexAttribArray(this.aTexCoord),this.aAlphaTexCoord=t.getAttribLocation(this.program,"a_alpha_texCoord"),t.enableVertexAttribArray(this.aAlphaTexCoord);var b=x.BYTES_PER_ELEMENT;t.vertexAttribPointer(this.aPosition,2,t.FLOAT,!1,6*b,0),t.vertexAttribPointer(this.aTexCoord,2,t.FLOAT,!1,6*b,2*b),t.vertexAttribPointer(this.aAlphaTexCoord,2,t.FLOAT,!1,6*b,4*b)}}},{key:"drawFrame",value:function(t,e){var n=this,o=e&&e.mediaTime>=0?e.mediaTime:this.video.currentTime,a=Math.round(o*this.options.fps)+this.options.offset;(this.events.frame||[]).forEach((function(t){t(a+1,o)}));var s=this.instance.gl;if(s){if(s.clear(s.COLOR_BUFFER_BIT),this.vapFrameParser){var c=this.vapFrameParser.getFrame(a),u=[];c&&c.obj&&c.obj.forEach((function(t,e){u[u.length]=+n.vapFrameParser.textureMap[t.srcId];var r=n.vapFrameParser.config.info,o=r.videoW,a=r.videoH,s=i(r.rgbFrame,2),c=s[0],l=s[1],h=i(t.frame,4),f=h[0],p=h[1],v=h[2],d=h[3],m=i(t.mFrame,4),y=m[0],g=m[1],x=m[2],b=m[3],_=F(f+c,p+l,v,d,o,a),w=F(y,g,x,b,o,a);u=u.concat(_).concat(w)}));var l=9*(s.getParameter(s.MAX_TEXTURE_IMAGE_UNITS)-1);u=u.concat(new Array(l-u.length).fill(0)),this._imagePos=this._imagePos||s.getUniformLocation(this.program,"image_pos"),s.uniform1fv(this._imagePos,new Float32Array(u))}s.texImage2D(s.TEXTURE_2D,0,s.RGB,s.RGB,s.UNSIGNED_BYTE,this.video),s.drawArrays(s.TRIANGLE_STRIP,0,4),v(b(r.prototype),"drawFrame",this).call(this,t,e)}else v(b(r.prototype),"drawFrame",this).call(this,t,e)}},{key:"destroy",value:function(){var t=this.instance,e=t.canvas,n=t.gl;if(this.textures&&this.textures.length)for(var o=0;o<this.textures.length;o++)n.deleteTexture(this.textures[o]);e&&e.parentNode&&e.parentNode.removeChild(e),v(b(r.prototype),"destroy",this).call(this),this.clearMemoryCache()}},{key:"clearMemoryCache",value:function(){C&&clearTimeout(C),C=setTimeout((function(){P={}}),18e5)}}]),r}(function(){function t(e){c(this,t),this.customEvent=["frame","percentage"],e.container&&e.src||console.warn("[Alpha video]: options container and src cannot be empty!"),this.options=Object.assign({src:"",loop:!1,fps:20,width:375,height:375,container:null,precache:!1,mute:!1,config:"",accurate:!1,offset:0},e),this.fps=20,this.setBegin=!0,this.useFrameCallback=!1,this.requestAnim=this.requestAnimFunc(),this.container=this.options.container,this.options.src&&this.options.config&&this.options.container?this.initVideo():console.error("参数出错：src(视频地址)、config(配置文件地址)、container(dom容器)")}return l(t,[{key:"precacheSource",value:function(t){var e=window.webkitURL||window.URL;return new Promise((function(r,n){var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="blob",o.onload=function(){if(200===o.status||304===o.status){var t=o.response;if(/iphone|ipad|ipod/i.test(navigator.userAgent)){var i=new FileReader;i.onloadend=function(){for(var t=i.result,n=atob(t.slice(t.indexOf(",")+1)),o=Array(n.length),a=0;a<n.length;a++)o[a]=n.charCodeAt(a);var s=new Uint8Array(o),c=new Blob([s],{type:"video/mp4"});r(e.createObjectURL(c))},i.readAsDataURL(o.response)}else r(e.createObjectURL(t))}else n(new Error("http response invalid"+o.status))},o.send()}))}},{key:"initVideo",value:function(){var t=this,e=this.options,r=this.video=document.createElement("video");r.crossOrigin="anonymous",r.autoplay=!1,r.preload="auto",r.setAttribute("playsinline",""),r.setAttribute("webkit-playsinline",""),e.mute&&(r.muted=!0,r.volume=0),r.style.display="none",r.loop=!!e.loop,e.precache?this.precacheSource(e.src).then((function(t){console.log("sample precached."),r.src=t,document.body.appendChild(r)})).catch((function(t){console.error(t)})):(r.src=e.src,document.body.appendChild(this.video),r.load()),"requestVideoFrameCallback"in this.video&&(this.useFrameCallback=!!this.options.accurate),this.events={},["playing","pause","ended","error","canplay"].forEach((function(e){t.on(e,t["on"+e].bind(t))}))}},{key:"drawFrame",value:function(t,e){this._drawFrame=this._drawFrame||this.drawFrame.bind(this,t,e),this.useFrameCallback?this.animId=this.video.requestVideoFrameCallback(this.drawFrame.bind(this)):this.animId=this.requestAnim(this._drawFrame)}},{key:"play",value:function(){var t=this,e=this.video&&this.video.play();e&&e.then&&e.catch((function(e){t.video&&(t.video.muted=!0,t.video.volume=0,t.video.play().catch((function(e){(t.events.error||[]).forEach((function(t){t(e)}))})))}))}},{key:"pause",value:function(){this.video&&this.video.pause()}},{key:"setTime",value:function(t){this.video&&(this.video.currentTime=t)}},{key:"requestAnimFunc",value:function(){var t=this;if(window.requestAnimationFrame){var e=-1;return function(r){return e++,requestAnimationFrame((function(){if(!(e%(60/t.fps)))return r();t.animId=t.requestAnim(r)}))}}return function(e){return setTimeout(e,1e3/t.fps)}}},{key:"cancelRequestAnimation",value:function(){if(this.useFrameCallback)try{this.video.cancelVideoFrameCallback(this.animId)}catch(t){}else window.cancelAnimationFrame?cancelAnimationFrame(this.animId):clearTimeout(this.animId)}},{key:"destroy",value:function(){this.cancelRequestAnimation(),this.video&&(this.video.parentNode&&this.video.parentNode.removeChild(this.video),this.video=null),this.options.onDestory&&this.options.onDestory()}},{key:"clear",value:function(){this.destroy()}},{key:"on",value:function(t,e){var r=this.events[t]||[];return r.push(e),this.events[t]=r,-1===this.customEvent.indexOf(t)&&this.video.addEventListener(t,e),this}},{key:"onplaying",value:function(){this.firstPlaying||(this.firstPlaying=!0,this.useFrameCallback||this.drawFrame(null,null))}},{key:"onpause",value:function(){}},{key:"onended",value:function(){this.destroy()}},{key:"oncanplay",value:function(){var t=this.options.beginPoint;t&&this.setBegin&&(this.setBegin=!1,this.video.currentTime=t)}},{key:"onerror",value:function(t){console.error("[Alpha video]: play error: ",t),this.destroy(),this.options.onLoadError&&this.options.onLoadError(t)}}]),t}());return function(t){if(function(){if(void 0!==k)return k;try{if(!window.WebGLRenderingContext)return!1;var t=document.createElement("canvas"),e=t.getContext("webgl")||t.getContext("experimental-webgl");k=!!e,e=null}catch(t){k=!1}return k}())return new R(Object.assign({},t));throw new Error("your browser not support webgl")}}()}}]);