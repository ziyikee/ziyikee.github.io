(window.HUYA_MAIN_APP_WEBPACK_JSONP=window.HUYA_MAIN_APP_WEBPACK_JSONP||[]).push([[236],{1237:function(e,t,i){},61:function(e,t,i){"use strict";i.r(t);i(1237),i(302);var r=i(0),n=i(3),o=i(8),a=i(34);function l(e){$.extend(this,new o.a).data=e}l.prototype={},l.prototype.constructor=l;var s=l;var d=new function(){var e=$.extend(this,new o.a),t=[];e.current=null,e.amount=0,e.add=function(i){i.on("end",(function(){e.current=null,e.current=t.shift(),e.current?(e.emit("show"),2!=e.current.data.iGiftBoxType&&0==e.current.data.index&&(e.amount-=e.current.data.iGiftBoxCount),e.emit("update:tips")):(e.amount=0,e.emit("update:tips"),e.emit("null"))})),e.current?(t.push(i),2!=i.data.iGiftBoxType&&0==i.data.index&&(e.amount+=i.data.iGiftBoxCount),e.emit("update:tips")):(e.current=i,e.emit("show"))},e.clear=function(){t=[],e.current=null,e.amount=0,e.emit("clear"),e.emit("update:tips")}};var u={type_1:1,type_2:20};function p(e){var t=$.extend(this,new o.a);t.type=e.type,t.giftArr=e.giftArr,t.standard=u["type_"+e.type],t.sendGift=function(e){r.default.call("giveGift",{num:e*u["type_"+t.type],fromType:1,type:20293})}}function c(){var e=$.extend(this,new o.a);e.ready=!1,a.default.then((function(t){e.giftShelf=t})),e.prizeList=d,e.type=1,e.superDelivery=null,e.chip=null,e.record=[],e.prizeStart=0,e.prizeOnceAmount=20,e.prizeTips=!1,e.prize=[],e.listen()}c.prototype={initialize:function(){var e=this;a.default.then((function(t){var i;r.default.ready((function(e){e.registerGroup("comm:giftboxserver")})),$.when((i=new $.Deferred,r.default.isH5&&r.default.ready((function(e){var t=new e.taf.HUYA.GetBoxPanelInfoReq;t.tUserId=e.userId,t.lPid=n.default.lp,e.sendWup2("revenueui","getBoxPanelInfo",t,(function(e){i.resolve(e)}))})),i.promise())).done((function(t){e.initBox(t.vLowGiftList.value,t.vHighGiftList.value),e.boxFlag=t.iBoxFlag,e.superDeliveryData={stBoxScore1:t.tScoreInfo,stBoxScore2:t.tScoreInfo2},e.handleSuperDelivery(),e.chip=t.tChipInfo;for(var i=t.vRecordList.value,r=0;r<i.length;r++)for(var n=i[r].vRecvItem.value,o=0;o<n.length;o++){if(88888!=n[o].iItemType){var a=$.extend({},i[r]);a.index=o,e.record.push(a)}}var l=e.record.length;l>3&&(e.record=e.record.slice(l-3)),e.ready=!0,e.emit("init")}))}))},handleSuperDelivery:function(){var e=this.superDeliveryData,t=$.extend({},this.superDelivery),i={};-1!=(i=0==this.boxFlag||e.stBoxScore1.iRemainTime?e.stBoxScore1:e.stBoxScore2.iRemainTime?e.stBoxScore2:2==e.stBoxScore1.iStatus?e.stBoxScore1:2==e.stBoxScore2.iStatus?e.stBoxScore2:e.stBoxScore1.iNextTimestamp<e.stBoxScore2.iNextTimestamp?e.stBoxScore1:e.stBoxScore2).lNewScore&&(this.superDelivery=i),1==this.superDelivery.tBigRecord.iFlag?this.superDelivery.tBigRecord.endTime=parseInt(+new Date/1e3)+this.superDelivery.tBigRecord.iCountDown:this.superDelivery.tBigRecord.endTime=0,0==e.lUid&&(this.superDelivery.lUid=t.lUid,this.superDelivery.sPidNickName=t.sPidNickName,this.superDelivery.sNickName=t.sNickName,this.superDelivery.lNewLastScore=t.lNewLastScore)},listen:function(){var e=this;r.default.isH5&&r.default.ready((function(t){var i=t;i.addTafListener("1031001",(function(t){TT.log("-----------------大吉市中奖信息推送",t);for(var i=t.vRecvItem.value,r=0;r<i.length;r++){if(88888!=i[r].iItemType){var n=$.extend({},t);n.index=r,e.record.push(n)}}var o=e.record.length;o>3&&(e.record=e.record.slice(o-3)),e.emit("update:record")})),i.addTafListener("1031002",(function(t){TT.log("-----------------大吉市中奖信息推送",t);for(var i=t.vRecvItem.value,r=0;r<i.length;r++){if(88888==i[r].iItemType&&(++e.chip.iChipCount==e.chip.iChipMax&&(e.chip.iChipCount=0),e.emit("update:chip")),1==e.type){if(0!=t.iGiftBoxType)continue}else if(0==t.iGiftBoxType)continue;var n=$.extend({},t);n.index=r;var o=new s(n);e.prizeList.add(o)}e.prizeTips=!0,e.emit("update:prizeList:new")})),i.addTafListener("1031004",(function(t){TT.log("-----------------大吉市分数面板推送",t),e.superDeliveryData=t,e.handleSuperDelivery(),e.emit("update:superDelivery")}))}))},initBox:function(e,t){this.box={type_1:new p({type:1,giftArr:e}),type_2:new p({type:2,giftArr:t})}},getPrizeList:function(){var e,t,i,n=this;$.when((e=n.prizeStart,t=n.prizeOnceAmount,i=new $.Deferred,r.default.isH5&&r.default.ready((function(r){var n=new r.taf.HUYA.UserPrizeRecordListReq;n.tUserId=r.userId,n.iStart=e,n.iCount=t,r.sendWup2("revenueui","getUserPrizeRecordList",n,(function(e){i.resolve(e)}))})),i.promise())).done((function(e){n.prize=e.vRecordList.value,n.emit("update:prizeList")}))},changeType:function(e){this.type!=e&&(this.type=e,this.emit("update:type"),this.prizeList.clear())},sendGift:function(e){this.box["type_"+this.type].sendGift(e)},quit:function(){r.default.ready((function(e){e.unRegisterGroup("comm:giftboxserver")}))}},c.prototype.constructor=c;var f=new c,m=i(1238),h=i.n(m),v=i(1239),y=i.n(v),g=i(1240),T=i.n(g);function w(e){function t(e){return e<10?"0"+e:e}return t((e=new Date(1e3*e)).getFullYear())+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())}function x(e){if(!(e.find(".gift-item").length<=3)){var t=null;!function i(){clearTimeout(t),t=setTimeout((function(){e.animate({top:"-70px"},200,(function(){var t=e.find(".gift-item").eq(0);e.append(t),e.css("top",0),i()}))}),2e3)}()}}function S(e){var t=this,r=i(1241);t.timer=null,t.delivery=e,t.state=0,t.stage=0,t.open=function(e,i,n){var o=t.delivery.$main.find(".stage-center");o.html(r({obj:{type:e,stage:1}})),clearTimeout(t.timer),t.timer=2!=e?setTimeout((function(){o.find(".stage-open").addClass("open"),clearTimeout(t.timer),t.timer=setTimeout((function(){n.resolve()}),1e3)}),i):setTimeout((function(){n.resolve()}),6e3)},t.clear=function(e){t.state=0;var i=t.delivery.$main.find(".stage-center");clearTimeout(t.timer),i.html(r({obj:{type:e,stage:0}}))},t.animate=function(e){2!=e.data.iGiftBoxType&&0!=e.data.index||(t.state=0),$.when(function(){var i=new $.Deferred;if(t.state)i.resolve();else{t.state=1;var r=10==e.data.iGiftBoxCount?800:400;t.open(e.data.iGiftBoxType,r,i)}return i.promise()}()).done((function(){if(2!=e.data.iGiftBoxType){var i=e.data.vRecvItem.value[e.data.index],n=t.delivery.model.giftShelf[i.iItemType];if(88888!=i.iItemType)var o=n?TT.trimUrl(n.vPropsIdentity.value[0].sPropsPic108.replace("&","?")):"";else o=T.a;var a={isChip:88888==i.iItemType.type,icon:o,amount:i.iItemCount};!function(e,i){var n=t.delivery.$main.find(".stage-center");clearTimeout(t.timer),n.html(r({obj:{type:e,stage:2,gift:i}}))}(t.delivery.model.type-1,a),t.timer=setTimeout((function(){88888!=i.iItemType?(t.delivery.$main.find(".stage-gift").addClass("move"),t.timer=setTimeout((function(){TT.log("-----------------------gift send end------------------"),e.emit("end")}),500)):(TT.log("-----------------------gift send end------------------"),e.emit("end"))}),1e3)}else e.emit("end")}))}}function z(){this.stageView=new S(this),this.model=f,this.listen()}z.prototype={superDeliveryTimer:null,superDeliveryCounter:null,initialize:function(e){if(!this.$view){var t=i(1242);$("body").append(t({_this:this})),void 0!==e&&(this.model.prizeTips=e),this.model.prizeList.clear(),this.$view=$(".delivery-panel"),this.$main=this.$view.find(".panel-main"),this.$prize=this.$view.find(".panel-prize"),this.model.initialize()}},render:function(){try{this.renderSuperDelivery(),this.renderBox(),this.renderRecord(),this.renderChip()}catch(e){}this.bindEvent()},renderSuperDelivery:function(){var e=this;clearTimeout(e.superDeliveryTimer),clearTimeout(e.superDeliveryCounter);var t=i(1243),r=e.model.superDelivery;if(r.iRemainTime>0&&(e.superDeliveryTimer=setTimeout((function(){e.model.superDeliveryData.stBoxScore1.iRemainTime=0,e.model.superDeliveryData.stBoxScore2.iRemainTime=0,e.model.handleSuperDelivery(),e.renderSuperDelivery()}),1e3*r.iRemainTime)),e.$main&&e.$main.find(".super-delivery").html(t({_this:e,obj:r,imgPeaNull:h.a,imgPeaFull:y.a})),1==r.tBigRecord.iFlag&&parseInt(+new Date/1e3)<r.tBigRecord.endTime){!function t(){clearTimeout(e.superDeliveryCounter);var i=parseInt(+new Date/1e3),n=r.tBigRecord.endTime-i;n>=0?(e.$view&&e.$view.find(".countdown").text(n+"s"),n<=60?e.$view&&e.$view.find(".countdown").addClass("red"):e.$view&&e.$view.find(".countdown").removeClass("red"),e.superDeliveryCounter=setTimeout((function(){t()}),1e3)):(r.tBigRecord.iFlag=0,e.model.superDeliveryData.stBoxScore1.tBigRecord.iCountDown=0,e.model.superDeliveryData.stBoxScore2.tBigRecord.iCountDown=0,e.model.handleSuperDelivery(),e.renderSuperDelivery())}()}},renderBox:function(){var e=i(1244),t=this.model.type,r=this.model.box["type_"+t],n=r.giftArr;r.leftShelf=[],r.rightShelf=[];for(var o=0;o<n.length;o++)o%2==0?r.leftShelf.push(n[o]):r.rightShelf.push(n[o]);r.leftShelf.length!=r.rightShelf.length&&r.rightShelf.push(r.leftShelf[0]),this.$main&&this.$main.find(".delivery-box").html(e({_this:this,obj:r,imgChip:T.a})),delete this.renderBox.leftShelf,delete this.renderBox.rightShelf,this.renderBox.leftShelf=new x(this.$main.find(".gift-shelf-left")),this.renderBox.rightShelf=new x(this.$main.find(".gift-shelf-right"))},renderRecord:function(){var e=i(1245),t=this.model.record;this.$main.find(".record").html(e({_this:this,obj:t}))},renderChip:function(){var e=i(1246),t=this.model.chip;this.$prize&&this.$prize.find(".prize-chip").html(e({obj:t}))},renderPrize:function(){var e,t=i(1247),r=this.model.prize;this.$prize&&this.$prize.find(".prize-bill").html(t({_this:this,obj:r,timeFormat:w,imgChip:T.a})),e={scrollbarWidth:6,mouseWheelSpeed:5,verticalGutter:5,isOutsideNotPrevent:!1},$(".j_prize-list-box").each((function(){var t=$(this).data("jsp");t?t.reinitialise():$(this).jScrollPane(e)}))},bindEvent:function(){var e=this;e.$view.on("click",".btn-close",(function(){e.model.quit(),e.model.prizeList.clear(),e.$view.remove(),e.$view=null})).on("click",".btn-prize",(function(){e.model.prizeList.clear(),e.model.prizeStart=0,e.model.getPrizeList(),e.$view.attr("panel","prize"),TTP.call("clearDeliveryTips"),e.model.prizeTips=!1,e.model.emit("update:prizeList:new")})).on("click",".btn-back",(function(){e.$view.attr("panel","main")})),e.$main.on("click",".type-item",(function(){var t=$(this).data("type");e.model.changeType(t)})).on("click",".super-delivery .open",(function(){e.model.changeType(2)})).on("click",".send-btn",(function(){var t=$(this).data("times");e.model.sendGift(t)})),e.$prize.on("click",".j_ctrl-item",(function(){var t=$(this).attr("type");"first"==t?e.model.prizeStart=0:"prev"==t?(e.model.prizeStart-=e.model.prizeOnceAmount,e.model.prizeStart=e.model.prizeStart<0?0:e.model.prizeStart):"next"==t&&20==e.model.prize.length&&(e.model.prizeStart+=e.model.prizeOnceAmount),e.model.getPrizeList()}))},listen:function(){var e=this;e.model.on("init",(function(){e.$view&&e.render()})),e.model.on("update:type",(function(){var t=e.model.type;e.$view.attr("type",t),e.renderSuperDelivery(),e.renderBox()})),e.model.on("update:superDelivery",(function(){e.renderSuperDelivery()})),e.model.on("update:record",(function(){e.renderRecord()})),e.model.on("update:chip",(function(){e.renderChip()})),e.model.on("update:prizeList",(function(){e.renderPrize()})),e.model.on("update:prizeList:new",(function(){e.model.prizeTips?e.$view&&e.$view.find(".btn-prize").addClass("new"):e.$view&&e.$view.find(".btn-prize").removeClass("new")})),e.model.prizeList.on("show",(function(){if(e.$view){var t=e.model.prizeList.current;e.stageView.animate(t)}})),e.model.prizeList.on("null",(function(){TT.log("prizeList is null"),e.stageView.clear(e.model.type-1)})),e.model.prizeList.on("clear",(function(){TT.log("prizeList clear"),e.$view&&e.stageView.clear(e.model.type-1)}))}},z.prototype.constructor=z;t.default=new z}}]);